@model EventSurveySetup

@{
    ViewData["Title"] = "Guest Question Setup";
}


<form asp-action="@(Model.IsEdit ? "GuesQuestionEdit" : "GuesQuestionCreate")" asp-controller="Event" method="post">
    <div style="background-color:#a7c8ff; min-height:100vh;">
        <div class="container py-4">
            <div class="bg-white p-4 rounded-4 shadow-sm">
                <h3 class="fw-bold mb-4">What do you need from your guest:</h3>

                <div class="mb-4">
                    <h5 class="fw-semibold mb-2">
                        Question Setup:
                        <i class="bi bi-info-circle ms-1" title="Setup the questions you want to ask your guest"></i>
                    </h5>
                    <p class="text-muted mb-0">
                        Here is where you set up your question to ask the guest.<br />
                        As example, you can ask about the pax, food restriction, or you can even set a predefined
                        answer in case there is a food menu.
                    </p>
                    <input asp-for="UserEventId" type="hidden" />
                    <input asp-for="UserEventId" type="hidden" />
                </div>

                <div id="question-container">
                    @for (var q = 0; q < Model.EventQuestionListModel.Count; q++)
                    {
                        <div class="bg-light p-3 rounded-3 mb-3 question-block" data-index="@q">
                            <div class="fw-bold mb-2">
                                Question <span class="question-number"></span>
                            </div>
                            <input class="form-control mb-2" name="EventQuestionListModel[@q].Question" value="@Model.EventQuestionListModel[q].Question" />

                            <div class="answers-container">
                                @for (var a = 0; a < Model.EventQuestionListModel[q].EventAnswerListModel.Count; a++)
                                {
                                    <label class="form-label">
                                        Answer <span class="answer-number"></span>
                                    </label>

                                    <div class="form-check mb-1 answer-block">
                                        <input class="form-control"
                                               name="EventQuestionListModel[@q].EventAnswerListModel[@a].Answer"
                                               value="@Model.EventQuestionListModel[q].EventAnswerListModel[a].Answer" />

                                        <input type="hidden"
                                               name="EventQuestionListModel[@q].EventAnswerListModel[@a].AnswerKeyword"
                                               value="@(a + 1)" />
                                    </div>
                                }
                            </div>

                            <button type="button" class="btn btn-sm btn-primary add-answer-btn">
                                Add Answer
                            </button>
                        </div>
                    }
                </div>

                <button type="button" id="add-question-btn" class="btn btn-success mt-3">
                    Add Question
                </button>

                <div id="question-template" class="d-none">
                    <div class="bg-light p-3 rounded-3 mb-3 question-block">
                        <div class="fw-bold mb-2">
                            Question <span class="question-number"></span>
                        </div>
                        <input class="form-control mb-2 question-input" name="__name__.Question" />

                        <div class="answers-container"></div>

                        <button type="button" class="btn btn-sm btn-primary add-answer-btn">
                            Add Answer
                        </button>
                    </div>
                </div>

                <div id="answer-template" class="d-none">
                    <div class="form-check mb-1 answer-block">
                        <label class="form-label">
                            Answer <span class="answer-number"></span>
                        </label>

                        <input class="form-control answer-input" name="__ansname__.Answer" />
                    </div>
                </div>

                <div class="text-end">
                    <button type="submit" class="btn btn-primary px-4">Next</button>
                </div>
            </div>

        </div>
        <script>
            let questionIndex = @Model.EventQuestionListModel.Count;

            document.addEventListener("DOMContentLoaded", function () {
                refreshQuestionNumbers();
                refreshAnswerNumbers();
            });

            document.getElementById("add-question-btn").addEventListener("click", function () {

                let template = document.getElementById("question-template").innerHTML;
                let html = template.replace(/__name__/g, `EventQuestionListModel[${questionIndex}]`);

                let container = document.getElementById("question-container");
                let block = document.createElement("div");
                block.innerHTML = html.trim();

                block.querySelector(".question-block").setAttribute("data-index", questionIndex);
                container.appendChild(block.firstElementChild);

                questionIndex++;

                refreshQuestionNumbers();
            });

            document.addEventListener("click", function (e) {
                if (e.target.classList.contains("add-answer-btn")) {

                    let questionBlock = e.target.closest(".question-block");
                    let qIndex = questionBlock.dataset.index;

                    let answersContainer = questionBlock.querySelector(".answers-container");

                    let aIndex = answersContainer.querySelectorAll(".answer-block").length;

                    let template = document.getElementById("answer-template").innerHTML;

                    let html = template.replace(/__ansname__/g,
                        `EventQuestionListModel[${qIndex}].EventAnswerListModel[${aIndex}]`
                    );

                    let block = document.createElement("div");
                    block.innerHTML = html.trim();

                    answersContainer.appendChild(block.firstElementChild);

                    refreshAnswerNumbers();
                }
            });

            function refreshAnswerNumbers() {
                const questionBlocks = document.querySelectorAll('.question-block');

                questionBlocks.forEach(block => {
                    const answerBlocks = block.querySelectorAll('.answer-block');
                    answerBlocks.forEach((ans, index) => {
                        const numSpan = ans.querySelector('.answer-number');
                        if (numSpan) numSpan.textContent = index + 1;
                    });
                });
            }

            function refreshQuestionNumbers() {
                const questionBlocks = document.querySelectorAll('.question-block');
                questionBlocks.forEach((block, index) => {
                    const numSpan = block.querySelector('.question-number');
                    if (numSpan) numSpan.textContent = index + 1;
                });
            }

        </script>
    </div>
</form>

