@model EventGuestListModel

@{
    ViewData["Title"] = "Setup Guest";
}

<div style="background-color:#a7c8ff; min-height:100vh;">
    <div class="container py-4">
        <div class="bg-white p-4 rounded-4 shadow-sm">
            <form id="guestForm" asp-action="GuestSetup" asp-controller="Event" method="post" enctype="multipart/form-data">
                <h3 class="fw-bold mb-4">Let's Setup Your Guest:</h3>
                <!-- Guest Setup Section -->
                <div class="mb-4">
                    <h5 class="fw-semibold mb-3">
                        Guest Setup:
                        <i class="bi bi-info-circle ms-1" title="Upload your guest list using the provided Excel template"></i>

                        <a href="@Url.Action("DownloadGuestTemplate", "Event")"
                           class="btn btn-outline-primary">
                            <i class="fa fa-download me-1"></i> Download Excel Template
                        </a>
                    </h5>

                    <!-- Upload Box -->
                    <div class="border border-secondary-subtle rounded-3 bg-light p-4 text-center" style="max-width:400px;">
                        <div class="mb-2">
                            <i class="bi bi-upload fs-1 text-secondary"></i>
                        </div>
                        <p class="mb-1 fw-medium">Click or drag file to this area to upload</p>
                        <p class="text-muted small mb-0">
                            Only upload one file and the only supported file type is from the template which is an .xlsx file.
                        </p>
                        <input asp-for="GuestFile" type="file" class="form-control mt-3" style="max-width:300px; margin:auto;"
                               onchange="document.getElementById('guestForm').submit();" />
                    </div>
                    <input asp-for="UserEventId" type="hidden" />
                </div>

                <!-- Guest Summary Table -->
                <div>
                    <h5 class="fw-semibold mb-3">Guest’s Information Summary:</h5>
                    <div class="table-responsive">
                        <table id="guestTable" class="table table-bordered align-middle text-center mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>No</th>
                                    <th>Name</th>
                                    <th>Mobile Number</th>
                                    <th>Valid</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model?.eventGuestList != null && Model.eventGuestList.Any())
                                {
                                    for (int i = 0; i < Model.eventGuestList.Count; i++)
                                    {
                                        var guest = Model.eventGuestList[i];
                                        <tr>
                                            <td class="row-number">@(i + 1)</td>
                                            <td>
                                                <input type="text" name="eventGuestList[@i].GuestName" class="form-control" value="@guest.GuestName" />
                                            </td>
                                            <td>
                                                <input type="text" name="eventGuestList[@i].PhoneNumber" class="form-control phone-input" value="@guest.PhoneNumber" />
                                            </td>
                                            <td>
                                                <span class="badge @(guest.IsValid ? "bg-success" : "bg-danger") is-valid-badge">
                                                    @(guest.IsValid ? "Active" : "No")
                                                </span>
                                                <input type="hidden" name="eventGuestList[@i].IsValid" value="@guest.IsValid.ToString().ToLower()" class="is-valid-input" />
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-danger btn-sm remove-row">Delete</button>
                                            </td>
                                            <input type="hidden" name="eventGuestList[@i].Id" value="@guest.Id" />
                                            <input type="hidden" name="eventGuestList[@i].UserEventId" value="@Model.UserEventId" />
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="5" class="text-muted">No guest data uploaded yet.</td>
                                    </tr>
                                }
                            </tbody>
                        </table>

                        @if (Model?.eventGuestList != null && Model.eventGuestList.Any())
                        {
                            <div class="mt-2 text-start">
                                <button type="button" id="addRowBtn" class="btn btn-primary btn-sm">Add Guest</button>
                            </div>
                        }
                    </div>
                </div>

                <script>
                    (function() {
                        let guestIndex = @Model.eventGuestList?.Count ?? 0;
                        const guestTable = document.getElementById('guestTable');
                        const tbody = guestTable ? guestTable.querySelector('tbody') : null;

                        // Phone number validation: must start with 6 and be 8-15 digits
                        function validatePhoneNumber(number) {
                            if (!number || typeof number !== 'string') return false;
                            const trimmed = number.trim();
                            return /^6\d{7,14}$/.test(trimmed);
                        }

                        // Update validity badge and input styling
                        function updatePhoneValidation(phoneInput) {
                            if (!phoneInput || !phoneInput.classList.contains('phone-input')) return;

                            const row = phoneInput.closest('tr');
                            if (!row) return;

                            const phone = phoneInput.value || '';
                            const isValid = validatePhoneNumber(phone);

                            // Update badge
                            const badge = row.querySelector('.is-valid-badge');
                            if (badge) {
                                badge.textContent = isValid ? "Active" : "No";
                                badge.className = 'badge ' + (isValid ? 'bg-success is-valid-badge' : 'bg-danger is-valid-badge');
                            }

                            // Update hidden input
                            const hiddenInput = row.querySelector('.is-valid-input');
                            if (hiddenInput) {
                                hiddenInput.value = isValid.toString();
                            }

                            // Update input styling
                            if (phone.trim() === '') {
                                phoneInput.classList.remove('is-invalid', 'is-valid');
                            } else if (isValid) {
                                phoneInput.classList.remove('is-invalid');
                                phoneInput.classList.add('is-valid');
                            } else {
                                phoneInput.classList.remove('is-valid');
                                phoneInput.classList.add('is-invalid');
                            }
                        }

                        // Validate all phone inputs on page load
                        function validateAllPhones() {
                            if (!tbody) return;
                            const phoneInputs = tbody.querySelectorAll('.phone-input');
                            phoneInputs.forEach(updatePhoneValidation);
                        }

                        // Initialize validation on page load
                        document.addEventListener('DOMContentLoaded', function() {
                            validateAllPhones();
                        });

                        // Also run immediately if DOM is already loaded
                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', validateAllPhones);
                        } else {
                            validateAllPhones();
                        }

                        // Event delegation for input events (works for dynamically added rows)
                        if (tbody) {
                            tbody.addEventListener('input', function (e) {
                                updatePhoneValidation(e.target);
                            });

                            // Handle blur event for better UX
                            tbody.addEventListener('blur', function (e) {
                                if (e.target.classList.contains('phone-input')) {
                                    updatePhoneValidation(e.target);
                                }
                            }, true);
                        }

                        // Add new row
                        const addRowBtn = document.getElementById('addRowBtn');
                        if (addRowBtn) {
                            addRowBtn.addEventListener('click', function () {
                                if (!tbody) return;

                                const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="row-number">${guestIndex + 1}</td>
                            <td><input type="text" name="eventGuestList[${guestIndex}].GuestName" class="form-control" /></td>
                            <td><input type="text" name="eventGuestList[${guestIndex}].PhoneNumber" class="form-control phone-input" /></td>
                            <td>
                                <span class="badge bg-danger is-valid-badge">No</span>
                                <input type="hidden" name="eventGuestList[${guestIndex}].IsValid" value="false" class="is-valid-input" />
                            </td>
                            <td>
                                <button type="button" class="btn btn-danger btn-sm remove-row">Delete</button>
                            </td>
                            <input type="hidden" name="eventGuestList[${guestIndex}].Id" value="0" />
                            <input type="hidden" name="eventGuestList[${guestIndex}].UserEventId" value="@Model.UserEventId" />
                        `;

                                tbody.appendChild(row);
                                guestIndex++;
                                updateRowNumbers();
                            });
                        }

                        // Delete row - use event delegation
                        if (tbody) {
                            tbody.addEventListener('click', function (e) {
                                if (e.target.classList.contains('remove-row')) {
                                    e.target.closest('tr').remove();
                                    updateRowNumbers();
                                }
                            });
                        }

                        // Update row numbers and input names for model binding
                        function updateRowNumbers() {
                            if (!tbody) return;
                            const rows = tbody.querySelectorAll('tr');
                            rows.forEach((tr, index) => {
                                const rowNumber = tr.querySelector('.row-number');
                                if (rowNumber) {
                                    rowNumber.textContent = index + 1;
                                }
                                tr.querySelectorAll('input, select').forEach(input => {
                                    if (input.name) {
                                        input.name = input.name.replace(/\[\d+\]/, `[${index}]`);
                                    }
                                });
                            });
                            guestIndex = rows.length;
                        }
                    })();
                </script>

                @if (Model?.eventGuestList != null && Model.eventGuestList.Any())
                {
                    <div class="mt-3 text-end">
                        <button type="submit" formaction="@Url.Action("SaveGuestList", "Event")" class="btn btn-success px-4">
                            Save Guests
                        </button>
                    </div>
                }
            </form>

        </div>
    </div>
</div>
